# RabbitMQ 高级功能示例

这个示例展示了如何使用 RabbitMQ 的各种高级功能，包括：

1. 连接管理和自动重连
2. 死信队列处理
3. 幂等性消费
4. 批量消息处理
5. 指标收集

## 前提条件

- Go 1.16+
- 运行中的 RabbitMQ 服务器 (默认 `localhost:5672`)
- RabbitMQ 管理插件 (用于指标收集，监听在 `localhost:15672`)

## 运行示例

示例程序提供两种运行模式：

### 基本模式

```bash
go run main.go features.go -mode basic
```

这将运行基本的 RabbitMQ 示例，包括：
- 设置交换机和队列
- 发布扫描任务
- 消费高、中、低优先级队列
- 直接使用死信队列处理失败消息（无重试机制）

### 高级模式

```bash
go run main.go features.go -mode advanced
```

这将运行高级功能示例，包括：
- 连接管理和自动重连
- 死信队列处理
- 幂等性消费
- 批量消息处理
- 指标收集
- 完整的消息流程演示

## 环境变量

可以通过环境变量配置 RabbitMQ 连接：

```bash
RABBITMQ_URL=amqp://user:password@host:port/ go run main.go features.go
```

## 功能说明

### 连接管理

`ConnectionManager` 提供了连接池和自动重连功能，确保应用程序可以在 RabbitMQ 服务中断后自动恢复。

### 死信队列处理

`DeadLetterConsumer` 专门处理失败的消息，提供记录和处理失败消息的能力。失败的消息会直接进入死信队列，由专门的处理器处理，不再尝试重试。

### 幂等性消费

示例提供了两种幂等性实现：

1. `IdempotentConsumer`（包装器）：基于RabbitMQ包中的实现，通过缓存消息ID确保消息只被处理一次。
2. `ImprovedIdempotentHandler`（改进版）：增强版实现，即使消息处理失败也能记录，避免无限重试同一消息。

### 批量消息处理

`BatchConsumer` 支持批量处理消息，而不是一次只处理一条，提高处理效率。

### 指标收集

`MetricsCollector` 通过 RabbitMQ 管理 API 收集队列和交换机的指标，如消息数量、消费者数量等。

## 错误处理设计

本示例使用了简化的错误处理策略：

1. **直接死信处理**：消息处理失败后，会直接进入死信队列，而不是尝试重试。这简化了处理逻辑，避免了无限重试导致的问题。
2. **专门的死信处理器**：`DeadLetterHandler` 专门处理进入死信队列的消息，可以进行日志记录、告警或其他失败处理逻辑。
3. **幂等性处理**：在高级模式中，幂等性处理确保即使消息多次投递，也只会被处理一次。

这种设计的优点：
- 简化消息处理逻辑
- 避免消息无限重试
- 将失败处理集中到专门的处理器
- 提高系统的稳定性和可靠性

## 示例消息

示例程序会自动发布以下类型的消息：

1. 高优先级漏洞扫描任务
2. 中优先级端口扫描任务（故意设置失败）
3. 低优先级网络发现任务
4. 资产更新任务

在高级模式下，还会定期发布批量消息和重复消息，用于测试批量处理和幂等性。

## 常见问题

### RabbitMQ连接断开

如果RabbitMQ服务器断开连接，`ConnectionManager` 会自动尝试重新连接，直到成功为止。这确保了应用程序的高可用性。 